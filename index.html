<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TABELA DE HOR√ÅRIOS ‚Äî Atualizada</title>

<!-- Firebase (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --bg:#ffffff;
    --muted:#666;
    --accent:#0288d1;
    --radius:10px;
    --shadow: 0 6px 18px rgba(0,0,0,0.06);
    --maxwidth:1100px;
    --gap:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:14px;
    font-family: "Arial", "Helvetica", sans-serif;
    background: #f5f7fb;
    color:#111;
  }
  .container{ max-width:var(--maxwidth); margin:0 auto; }

  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  header h1{ margin:0; font-size:20px; text-transform:uppercase; letter-spacing:0.6px; }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  input[type="text"], select{ padding:8px 10px; border-radius:8px; border:1px solid #e6edf3; background:white; min-width:140px; }
  button{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow:var(--shadow); }
  button.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(2,136,209,0.12); box-shadow:none; }
  button.warn{ background:#ef4444; }

  .layout{ display:grid; grid-template-columns: 1fr 340px; gap:14px; align-items:start; }

  .sectors{ display:flex; flex-direction:column; gap:12px; }
  .turno{
    background: #fff;
    border-radius:12px;
    padding:12px;
    box-shadow:var(--shadow);
    border-left:10px solid #333;
    position:relative;
    overflow:hidden;
  }
  .turno h2{ margin:0; font-size:14px; display:flex; justify-content:space-between; align-items:center; text-transform:uppercase; }
  .turno .contador{ font-weight:700; font-size:13px; color:#333; background:#f1f5f9; padding:4px 8px; border-radius:999px; }

  .data-horario{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .data-horario input{ padding:7px; border-radius:6px; border:1px solid #ddd; font-size:16px; font-weight:bold; text-align:center; color:#000; }

  .funcionarios-container{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:8px; margin-top:12px; }
  .funcionario{
    display:flex;
    gap:8px;
    align-items:center;
    padding:8px;
    border-radius:8px;
    border:1px solid #e6edf3;
    background:linear-gradient(180deg,#fff,#fbfdff);
  }

  .funcionario .name{ flex:1; font-weight:700; font-size:13px; cursor:text; min-width:80px; }
  .func-actions{ display:flex; gap:6px; align-items:center; }

  .icon-btn{ background:transparent; border:none; cursor:pointer; font-size:16px; }

  /* Empilhadores layout novo */
  .funcionario.empilhador {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    padding: 8px;
  }
  .funcionario.empilhador .name {
    flex: 1 1 140px;
  }
  .empilhador-dados {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .empilhador-dados select {
    min-width: 90px;
  }
  .empilhador-dados input { font-size:16px; font-weight:bold; text-align:center; color:#000;
    width: 86px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ddd;
  }
  .empilhador-actions {
    margin-left: auto;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  /* Checkout */
  .funcionario.checkout{ flex-direction:column; align-items:flex-start; gap:6px; }
  .funcionario.checkout .row{ display:flex; gap:6px; width:100%; align-items:center; }
  .horario-alt-wrapper{ display:flex; gap:6px; align-items:center; width:100%; }
  .horario-alt-wrapper input{ flex:1; padding:6px; border-radius:6px; border:1px solid #ddd; }

  /* paleta */
  .btn-paleta{ position:absolute; top:10px; right:10px; background:transparent; border:none; cursor:pointer; font-size:18px; }
  .paleta-cores{ display:none; position:absolute; top:40px; right:10px; background:#fff; padding:8px; border-radius:8px; border:1px solid #eee; box-shadow:var(--shadow); }
  .paleta-cores button{ width:22px; height:22px; border-radius:5px; border:none; margin:2px; cursor:pointer; }

  /* right column */
  aside{ display:flex; flex-direction:column; gap:12px; }
  .panel{ background:#fff; padding:12px; border-radius:12px; box-shadow:var(--shadow); }

  /* responsive */
  @media (max-width:980px){
    .layout{ grid-template-columns:1fr; }
    aside{ order:2; }
  }

  /* print */
  @media print {
    #empilhadores, #checkout1, #checkout2 {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
    }
    header, .controls, .panel, .btn-paleta, .paleta-cores, button.ghost { display:none !important; }
    .turno { page-break-inside: avoid; border-left-width:6px; }
    #empilhadores, #checkout1, #checkout2 { page-break-inside: avoid; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>TABELA DE HOR√ÅRIOS</h1>
    <div class="controls" id="controles">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="busca" type="text" placeholder="Buscar funcion√°rio..." aria-label="buscar">
        <button class="ghost" id="limparBusca">Limpar</button>
      </div>

      <input id="nomeNovo" type="text" placeholder="NOME" />
      <select id="setorNovo">
        <option value="separador1">SEPARADOR 1¬∫ TURNO</option>
        <option value="separador2">SEPARADOR 2¬∫ TURNO</option>
        <option value="donoderua1">DONO DE RUA 1¬∫ TURNO</option>
        <option value="donoderua2">DONO DE RUA 2¬∫ TURNO</option>
        <option value="checkout1">CHECKOUT 1¬∫ TURNO</option>
        <option value="checkout2">CHECKOUT 2¬∫ TURNO</option>
        <option value="empilhadores">EMPILHADORES</option>
        <option value="expedicao1">EXPEDI√á√ÉO 1¬∫ TURNO</option>
        <option value="expedicao2">EXPEDI√á√ÉO 2¬∫ TURNO</option>
      </select>

      <button id="btnAdd">ADICIONAR</button>
      <button id="btnSave">SALVAR</button>
      <button id="btnPDF">PDF</button>
      <button id="btnPrint">IMPRIMIR</button>
    </div>
  </header>

  <div class="layout">
    <main class="sectors" id="sectorsRoot">
      <!-- setores criados via JS -->
    </main>

    <aside>
      <div class="panel">
        <h3>Paleta global</h3>
        <div id="paletaGlobal" style="display:flex;gap:8px;flex-wrap:wrap">
          <!-- usando mesma paleta do HTML original -->
          <div class="color-swatch" style="background:#FFCCBC" data-color="#FFCCBC"></div>
          <div class="color-swatch" style="background:#E1BEE7" data-color="#E1BEE7"></div>
          <div class="color-swatch" style="background:#B2DFDB" data-color="#B2DFDB"></div>
          <div class="color-swatch" style="background:#F8BBD0" data-color="#F8BBD0"></div>
          <div class="color-swatch" style="background:#D1C4E9" data-color="#D1C4E9"></div>
          <div class="color-swatch" style="background:#C5CAE9" data-color="#C5CAE9"></div>
          <div class="color-swatch" style="background:#FFF9C4" data-color="#FFF9C4"></div>
          <div class="color-swatch" style="background:#FFECB3" data-color="#FFECB3"></div>
          <div class="color-swatch" style="background:#FFE0B2" data-color="#FFE0B2"></div>
          <div class="color-swatch" style="background:#DCEDC8" data-color="#DCEDC8"></div>
          <div class="color-swatch" style="background:#C8E6C9" data-color="#C8E6C9"></div>
          <div class="color-swatch" style="background:#BBDEFB" data-color="#BBDEFB"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Export / Import</h3>
        <div style="display:flex;gap:8px;flex-direction:column">
          <button id="btnExportJSON" class="ghost">Exportar JSON</button>
          <button id="btnImportJSON" class="ghost">Importar JSON (colar)</button>
          <textarea id="jsonImportArea" style="display:none;width:100%;height:120px;margin-top:8px" placeholder="Cole JSON aqui"></textarea>
        </div>
      </div>

      <div class="panel">
        <h3>Ajuda</h3>
        <p style="margin:0;color:var(--muted);font-size:13px">Clique no nome para editar; use üîÅ para mover entre turnos relacionados; empilhadores e checkouts t√™m campos especiais.</p>
      </div>
    </aside>
  </div>
</div>

<!-- logo escondido para PDF -->
<img id="logoPDF" src="LOGO_DUR√ÉES_VETORIZADA.png" alt="logo" style="display:none">

<script>
  /* Firebase config (mesma do original) */
  const firebaseConfig = {
    apiKey: "AIzaSyAvtcqhy-bj1iOpBVcIPBjvNfYygjHSpAY",
    authDomain: "horarios-duraes.firebaseapp.com",
    projectId: "horarios-duraes",
    storageBucket: "horarios-duraes.firebasestorage.app",
    messagingSenderId: "801770957942",
    appId: "1:801770957942:web:ce5d664d7f084281ac4357"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* setores e labels (mantendo IDs do seu original) */
  const SETORES = [
    {id:'separador1', label:'SEPARADOR - 1¬∫ TURNO', swapWith:'separador2'},
    {id:'separador2', label:'SEPARADOR - 2¬∫ TURNO', swapWith:'separador1'},
    {id:'donoderua1', label:'DONO DE RUA - 1¬∫ TURNO', swapWith:'donoderua2'},
    {id:'donoderua2', label:'DONO DE RUA - 2¬∫ TURNO', swapWith:'donoderua1'},
    {id:'checkout1', label:'CHECKOUT - 1¬∫ TURNO', swapWith:'checkout2'},
    {id:'checkout2', label:'CHECKOUT - 2¬∫ TURNO', swapWith:'checkout1'},
    {id:'empilhadores', label:'EMPILHADORES', swapWith:null},
    {id:'expedicao1', label:'EXPEDI√á√ÉO - 1¬∫ TURNO', swapWith:'expedicao2'},
    {id:'expedicao2', label:'EXPEDI√á√ÉO - 2¬∫ TURNO', swapWith:'expedicao1'}
  ];

  /* cria setores no DOM */
  const sectorsRoot = document.getElementById('sectorsRoot');
  function criarSectorDOM(s){
    const div = document.createElement('div');
    div.className = 'turno';
    div.id = s.id;

    // bot√µes de paleta (mantendo a paleta por setor do original)
    const palBtn = document.createElement('button');
    palBtn.className = 'btn-paleta';
    palBtn.type = 'button';
    palBtn.innerText = 'üé®';
    palBtn.onclick = (e) => {
      e.stopPropagation();
      const pal = div.querySelector('.paleta-cores');
      pal.style.display = pal.style.display === 'block' ? 'none' : 'block';
    };

    const paleta = document.createElement('div');
    paleta.className = 'paleta-cores';
    // acrescenta as cores iguais ao original por setor
    const cores = [
      '#FFCCBC','#E1BEE7','#B2DFDB','#F8BBD0','#D1C4E9','#C5CAE9',
      '#FFF9C4','#FFECB3','#FFE0B2','#FFCDD2','#F8BBD0','#E1BEE7',
      '#DCEDC8','#C8E6C9','#A5D6A7','#81C784','#66BB6A','#4CAF50',
      '#FFE082','#FFCC80','#FFD54F','#FFB74D','#FF9800','#FB8C00',
      '#BBDEFB','#90CAF9','#64B5F6','#42A5F5','#2196F3','#1E88E5'
    ];
    cores.slice(0,6).forEach(c => {
      const b = document.createElement('button');
      b.style.background = c;
      b.dataset.color = c;
      b.onclick = (ev) => { ev.stopPropagation(); div.style.background = c; paleta.style.display='none'; };
      paleta.appendChild(b);
    });

    // header
    div.innerHTML = `<h2>${s.label} <span class="contador">(0)</span></h2>
      <div class="data-horario"><input placeholder="DATA"/><input placeholder="HOR√ÅRIO"/></div>
      <div class="funcionarios-container"></div>`;

    div.appendChild(palBtn);
    div.appendChild(paleta);
    sectorsRoot.appendChild(div);
  }
  SETORES.forEach(criarSectorDOM);

  /* utilit√°rios */
  function atualizarContador(setorId){
    const cnt = document.getElementById(setorId).querySelector('.funcionarios-container').children.length;
    const badge = document.getElementById(setorId).querySelector('.contador');
    if(badge) badge.textContent = `(${cnt})`;
  }

  /* criar funcion√°rio (ATUALIZADO: empilhadores e checkouts organizados) */
  function criarFuncionario(nome, setorId, opts = {}) {
    const container = document.getElementById(setorId).querySelector('.funcionarios-container');
    const div = document.createElement('div');
    div.className = 'funcionario';
    div.dataset.sector = setorId;

    // classes espec√≠ficas
    if (setorId === 'empilhadores') div.classList.add('empilhador');
    if (setorId === 'checkout1' || setorId === 'checkout2') div.classList.add('checkout');

    // nome edit√°vel
    const nameSpan = document.createElement('div');
    nameSpan.className = 'name';
    nameSpan.contentEditable = true;
    nameSpan.spellcheck = false;
    nameSpan.textContent = nome || 'NOME';
    nameSpan.title = 'Clique para editar';

    // a√ß√µes (bot√µes) - criados aqui e adicionados depois onde for melhor visualmente
    const btnMove = document.createElement('button');
    btnMove.className = 'icon-btn';
    btnMove.title = 'Trocar turno';
    btnMove.innerHTML = 'üîÅ';
    btnMove.onclick = (e) => { e.stopPropagation(); moverFuncionario(div); };

    const btnDel = document.createElement('button');
    btnDel.className = 'icon-btn';
    btnDel.title = 'Excluir';
    btnDel.innerHTML = 'üóëÔ∏è';
    btnDel.onclick = (e) => { e.stopPropagation(); if(confirm('Remover funcion√°rio?')){ const sec = div.dataset.sector; div.remove(); atualizarContador(sec); ordenarFuncionarios(sec); } };

    // empilhadores: nome + bloco com turno/data/hor√°rio + bot√µes √† direita
    if (setorId === 'empilhadores') {
      const dadosWrap = document.createElement('div');
      dadosWrap.className = 'empilhador-dados';

      const select = document.createElement('select');
      select.innerHTML = '<option value="1">1¬∫ TURNO</option><option value="2">2¬∫ TURNO</option><option value="3">3¬∫ TURNO</option>';
      select.value = opts.turno || '1';

      const inData = document.createElement('input');
      inData.placeholder = 'DATA';
      inData.value = opts.data || '';

      const inHora = document.createElement('input');
      inHora.placeholder = 'HOR√ÅRIO';
      inHora.value = opts.horario || '';

      dadosWrap.appendChild(select);
      dadosWrap.appendChild(inData);
      dadosWrap.appendChild(inHora);

      const actionsWrap = document.createElement('div');
      actionsWrap.className = 'empilhador-actions';
      actionsWrap.appendChild(btnMove);
      actionsWrap.appendChild(btnDel);

      div.appendChild(nameSpan);
      div.appendChild(dadosWrap);
      div.appendChild(actionsWrap);
    } else {
      // checkouts e demais: nome no topo
      div.appendChild(nameSpan);
    }

    // checkout: adiciona hor√°rio alternativo abaixo com legenda "Alt."
    if (setorId === 'checkout1' || setorId === 'checkout2') {
      const altWrap = document.createElement('div');
      altWrap.className = 'horario-alt-wrapper';
      const lbl = document.createElement('span');
      lbl.textContent = 'Alt.:';
      lbl.style.fontSize = '12px';
      lbl.style.color = '#d32f2f';
      lbl.style.minWidth = '28px';
      const inAlt = document.createElement('input');
      inAlt.placeholder = 'HOR√ÅRIO ALT.';
      inAlt.value = opts.horarioAlt || '';
      altWrap.appendChild(lbl);
      altWrap.appendChild(inAlt);
      div.appendChild(altWrap);
    }

    // a√ß√µes para demais setores (coloca o container de a√ß√µes √† direita)
    if (setorId !== 'empilhadores') {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.width = '100%';
      row.style.alignItems = 'center';
      // colocar as a√ß√µes no final (visual)
      const actions = document.createElement('div');
      actions.className = 'func-actions';
      actions.appendChild(btnMove);
      actions.appendChild(btnDel);
      row.appendChild(actions);
      div.appendChild(row);
    }

    container.appendChild(div);
    ordenarFuncionarios(setorId);
    atualizarContador(setorId);

    // reordenar ao editar nome
    nameSpan.addEventListener('blur', () => ordenarFuncionarios(setorId));
  }

  /* ordena√ß√£o por nome (ignora outros campos) */
  function ordenarFuncionarios(setorId) {
    const container = document.getElementById(setorId).querySelector('.funcionarios-container');
    const items = Array.from(container.querySelectorAll('.funcionario'));
    items.sort((a, b) => {
      const an = a.querySelector('.name')?.textContent.trim().toLowerCase() || '';
      const bn = b.querySelector('.name')?.textContent.trim().toLowerCase() || '';
      return an.localeCompare(bn, 'pt-BR');
    });
    items.forEach(it => container.appendChild(it));
  }

  /* mover funcion√°rio para setor parceiro (swapWith) */
  function moverFuncionario(funcDiv) {
    const current = funcDiv.dataset.sector;
    const def = SETORES.find(s => s.id === current);
    const destino = def && def.swapWith ? def.swapWith : null;
    if(!destino){ alert('Setor sem parceiro de troca r√°pida.'); return; }
    document.getElementById(destino).querySelector('.funcionarios-container').appendChild(funcDiv);
    funcDiv.dataset.sector = destino;
    ordenarFuncionarios(destino);
    atualizarContador(current);
    atualizarContador(destino);
  }

  /* adicionar via bot√£o */
  document.getElementById('btnAdd').addEventListener('click', () => {
    const nome = document.getElementById('nomeNovo').value.trim();
    const setor = document.getElementById('setorNovo').value;
    if(!nome){ alert('Informe um nome'); return; }
    criarFuncionario(nome, setor);
    document.getElementById('nomeNovo').value = '';
  });

  /* busca */
  const buscaEl = document.getElementById('busca');
  buscaEl.addEventListener('input', e => {
    const q = e.target.value.trim().toLowerCase();
    document.querySelectorAll('.funcionario').forEach(f => {
      const nome = f.querySelector('.name')?.textContent.toLowerCase() || '';
      f.style.display = nome.includes(q) ? 'flex' : 'none';
    });
  });
  document.getElementById('limparBusca').addEventListener('click', () => { buscaEl.value=''; buscaEl.dispatchEvent(new Event('input')); });

  /* paleta global aplica cor ao √∫ltimo setor clicado */
  document.getElementById('paletaGlobal').addEventListener('click', (e) => {
    const color = e.target.dataset?.color;
    if(!color) return;
    const last = window.__lastSectorClicked || SETORES[0].id;
    document.getElementById(last).style.background = color;
  });
  document.addEventListener('click', (e) => {
    const sec = e.target.closest('.turno');
    if(sec) window.__lastSectorClicked = sec.id;
  });

  /* palette local (cada setor j√° tem bot√£o que abre) */
  // (j√° definido quando criamos os bot√µes)

  /* salvar dados no Firestore (adaptado para empilhadores e checkout) */
  function salvarDados(){
    const dados = {};
    SETORES.forEach(s => {
      const sec = document.getElementById(s.id);
      const inputs = sec.querySelectorAll('.data-horario input');
      const data = inputs[0]?.value || '';
      const horario = inputs[1]?.value || '';
      const arr = [];
      sec.querySelectorAll('.funcionario').forEach(f => {
        const nome = f.querySelector('.name')?.textContent || '';
        if(s.id === 'empilhadores'){
          const select = f.querySelector('select');
          const turno = select ? select.value : '1';
          const dataEmp = f.querySelector('input[placeholder="DATA"]')?.value || '';
          const horaEmp = f.querySelector('input[placeholder="HOR√ÅRIO"]')?.value || '';
          arr.push({nome, turno, data: dataEmp, horario: horaEmp});
        } else if(s.id === 'checkout1' || s.id === 'checkout2'){
          const horarioAlt = f.querySelector('.horario-alt-wrapper input')?.value || '';
          arr.push({nome, horarioAlt});
        } else {
          arr.push(nome);
        }
      });
      dados[s.id] = { data, horario, funcionarios: arr, bg: sec.style.background || '' };
    });

    db.collection("tabela").doc("horarios").set(dados).then(() => alert('DADOS SALVOS NO FIREBASE')).catch(e => { console.error(e); alert('Erro ao salvar: ' + e.message); });
  }
  document.getElementById('btnSave').addEventListener('click', salvarDados);

  /* carregar dados do Firestore (mantendo empilhadores + checkout) */
  function carregarDados(){
    db.collection("tabela").doc("horarios").get().then(doc => {
      if(!doc.exists) return;
      const dados = doc.data();
      for(const setorId in dados){
        if(!document.getElementById(setorId)) continue;
        const info = dados[setorId];
        const sec = document.getElementById(setorId);
        const inputs = sec.querySelectorAll('.data-horario input');
        if(inputs[0]) inputs[0].value = info.data || '';
        if(inputs[1]) inputs[1].value = info.horario || '';
        if(info.bg) sec.style.background = info.bg;

        const cont = sec.querySelector('.funcionarios-container');
        cont.innerHTML = '';
        (info.funcionarios || []).forEach(item => {
          if(setorId === 'empilhadores'){
            const {nome, turno, data, horario} = item || {};
            criarFuncionario(nome || '', setorId, {turno, data, horario});
          } else if(setorId === 'checkout1' || setorId === 'checkout2'){
            const {nome, horarioAlt} = (typeof item === 'string') ? {nome: item, horarioAlt: ''} : item;
            criarFuncionario(nome || '', setorId, {horarioAlt});
            // definir valor do input alt se necess√°rio
            const last = cont.lastElementChild;
            if(last){
              const inAlt = last.querySelector('.horario-alt-wrapper input');
              if(inAlt) inAlt.value = horarioAlt || '';
            }
          } else {
            const nome = typeof item === 'string' ? item : (item.nome || '');
            criarFuncionario(nome || '', setorId);
          }
        });
        ordenarFuncionarios(setorId);
        atualizarContador(setorId);
      }
    }).catch(e => { console.error('Erro ao carregar', e); });
  }
  window.addEventListener('load', carregarDados);

  /* gerar PDF (limpando controles e inputs vazios) */
  function gerarPDF(){
    const cloneRoot = document.createElement('div');
    const logo = document.getElementById('logoPDF').cloneNode();
    logo.style.display = 'block'; logo.style.margin='6px auto';
    const h = document.createElement('h1');
    h.textContent = 'Tabela de Hor√°rios';
    h.style.textAlign = 'center';
    h.style.fontSize = '18px';
    cloneRoot.appendChild(logo);
    cloneRoot.appendChild(h);

    SETORES.forEach(s => {
      const sec = document.getElementById(s.id);
      const secClone = sec.cloneNode(true);
      // remove controles visuais e bot√µes
      secClone.querySelectorAll('.btn-paleta, .paleta-cores, .func-actions, button').forEach(n => n.remove());
      // limpar inputs vazios, transformar inputs com valor em texto
      secClone.querySelectorAll('input').forEach(inp => {
        const parent = inp.parentElement;
        const isAlt = parent && parent.classList && parent.classList.contains('horario-alt-wrapper');
        if((!inp.value || inp.value.trim()==='') && isAlt){
          // remove o bloco inteiro do hor√°rio alternativo vazio (label + input)
          parent.remove();
        } else if (!inp.value || inp.value.trim() === '') {
          inp.remove();
        } else {
          const span = document.createElement('div');
          span.textContent = inp.value;
          span.style.fontSize='12px';
          span.style.color='#333';
          inp.replaceWith(span);
        }
      });
      // remove contentEditable caret - garantir nomes como texto
      secClone.querySelectorAll('.name').forEach(n => {
        const txt = document.createElement('div');
        txt.textContent = n.textContent || '';
        txt.style.fontWeight='700';
        n.replaceWith(txt);
      });
      // remove selects (substituir por texto)
      secClone.querySelectorAll('select').forEach(sel => {
        const txt = document.createElement('div');
        txt.textContent = sel.value + '¬∫ TURNO';
        sel.replaceWith(txt);
      });
      secClone.style.pageBreakInside = 'avoid';
      cloneRoot.appendChild(secClone);
    });

    html2pdf().set({
      margin: 8,
      filename: 'tabela_horarios_' + new Date().toISOString().slice(0,10) + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(cloneRoot).save();
  }
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);

  /* imprimir */
  document.getElementById('btnPrint').addEventListener('click', () => window.print());

  /* export / import JSON local */
  document.getElementById('btnExportJSON').addEventListener('click', () => {
    const dados = {};
    SETORES.forEach(s => {
      const sec = document.getElementById(s.id);
      const inputs = sec.querySelectorAll('.data-horario input');
      const data = inputs[0]?.value || '';
      const horario = inputs[1]?.value || '';
      const arr = [];
      sec.querySelectorAll('.funcionario').forEach(f => {
        const nome = f.querySelector('.name')?.textContent || '';
        if(s.id === 'empilhadores'){
          const select = f.querySelector('select');
          const turno = select ? select.value : '1';
          const dataEmp = f.querySelector('input[placeholder="DATA"]')?.value || '';
          const horaEmp = f.querySelector('input[placeholder="HOR√ÅRIO"]')?.value || '';
          arr.push({nome, turno, data: dataEmp, horario: horaEmp});
        } else if(s.id === 'checkout1' || s.id === 'checkout2'){
          const alt = f.querySelector('.horario-alt-wrapper input')?.value || '';
          arr.push({nome, horarioAlt: alt});
        } else {
          arr.push(nome);
        }
      });
      dados[s.id] = { data, horario, funcionarios: arr, bg: sec.style.background || '' };
    });
    const blob = new Blob([JSON.stringify(dados, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tabela_export_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnImportJSON').addEventListener('click', () => {
    const area = document.getElementById('jsonImportArea');
    if(area.style.display === 'none'){ area.style.display='block'; area.focus(); return; }
    try{
      const obj = JSON.parse(area.value);
      for(const setorId in obj){
        if(!document.getElementById(setorId)) continue;
        const sec = document.getElementById(setorId);
        const cont = sec.querySelector('.funcionarios-container');
        cont.innerHTML = '';
        (obj[setorId].funcionarios || []).forEach(it => {
          if(setorId === 'empilhadores'){
            criarFuncionario(it.nome, setorId, {turno: it.turno, data: it.data, horario: it.horario});
          } else if(setorId === 'checkout1' || setorId === 'checkout2'){
            criarFuncionario(it.nome, setorId, {horarioAlt: it.horarioAlt});
            const last = cont.lastElementChild;
            if(last){
              const inAlt = last.querySelector('.horario-alt-wrapper input');
              if(inAlt) inAlt.value = it.horarioAlt || '';
            }
          } else {
            const nome = typeof it === 'string' ? it : (it.nome || '');
            criarFuncionario(nome, setorId);
          }
        });
        const inputs = sec.querySelectorAll('.data-horario input');
        if(inputs[0]) inputs[0].value = obj[setorId].data || '';
        if(inputs[1]) inputs[1].value = obj[setorId].horario || '';
        if(obj[setorId].bg) sec.style.background = obj[setorId].bg;
      }
      area.style.display = 'none'; area.value = '';
      alert('Importado com sucesso');
    }catch(e){ alert('JSON inv√°lido: ' + e.message); }
  });

  /* atalhos: Ctrl+S salvar, Ctrl+F focus busca */
  document.addEventListener('keydown', (e) => {
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); salvarDados(); }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f'){ e.preventDefault(); buscaEl.focus(); }
  });

  /* seed visual (apenas se estiver vazio) */
  function seedLocalIfEmpty(){
    const any = SETORES.some(s => document.getElementById(s.id).querySelector('.funcionarios-container').children.length > 0);
    if(any) return;
    criarFuncionario('Carlos Silva','separador1');
    criarFuncionario('Mariana Lima','separador1');
    criarFuncionario('Jo√£o Pedro','checkout1',{horarioAlt:'18:00'});
    criarFuncionario('Ana Paula','checkout2',{horarioAlt:'19:00'});
    criarFuncionario('Rog√©rio','empilhadores',{turno:'2',data:'10/08/2025',horario:'07:00'});
    SETORES.forEach(s => atualizarContador(s.id));
  }
  seedLocalIfEmpty();

</script>
</body>
</html>
